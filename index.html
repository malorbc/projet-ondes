<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ondes</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</head>

<body>
    <div class="map-container">
        <div id='map' style='width:100%; height: 800px;'></div>

    </div>
</body>
<style>
    .map-container {
        width: 50%;
        margin: auto;
        height: calc(100vh - 105px)
    }
</style>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFsb21hbG8iLCJhIjoiY2t0dTE3aXMzMGRseTJ2bXJsb3NkYm1raSJ9.33gvyhV7KNPPsLuQv0Le3g';
    const map = new mapboxgl.Map({
        style: 'mapbox://styles/mapbox/light-v10',
        //longitude - latitude
        center: [6.863849, 47.639674],
        zoom: 15.5,
        pitch: 45,
        bearing: -17.6,
        container: 'map',
        antialias: true
    });

    function generateCircles(nb) {
        let arrayCircles = [];
        let max = 999999;
        let min = 0;
        for (i = 0; i < nb; i++) {
            let randomLat = Math.random() * (max - min) + min;
            let randomLong = Math.random() * (max - min) + min;

            let lat = "6." + randomLat;
            lat = parseFloat(lat);

            let long = "47." + randomLong;
            long = parseFloat(long);

            let center = [lat, long];
            let radius = Math.random() * (400 - 50) + 50;
            let options = {
                steps: 50,
                units: 'meters',
                properties: {
                    nom: 'Antenne ' + i
                }
            }
            let circle = turf.circle(center, radius, options);
            arrayCircles.push(circle);
        }

        let collection = turf.featureCollection(arrayCircles);
        return collection;
    }

    map.on('load', () => {
        // Insert the layer beneath any symbol layer.
        const layers = map.getStyle().layers;
        const labelLayerId = layers.find(
            (layer) => layer.type === 'symbol' && layer.layout['text-field']
        ).id;

        // The 'building' layer in the Mapbox Streets
        // vector tileset contains building height data
        // from OpenStreetMap.

        map.addControl(
            new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                // When active the map will receive updates to the device's location as it changes.
                trackUserLocation: true,
                // Draw an arrow next to the location dot to indicate which direction the device is heading.
                showUserHeading: true
            })
        );

        map.addLayer(
            {
                'id': 'add-3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 15,
                'paint': {
                    'fill-extrusion-color': '#aaa',

                    // Use an 'interpolate' expression to
                    // add a smooth transition effect to
                    // the buildings as the user zooms in.
                    'fill-extrusion-height': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'height']
                    ],
                    'fill-extrusion-base': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'min_height']
                    ],
                    'fill-extrusion-opacity': 0.6
                }
            },
            labelLayerId
        );

        map.addSource('test', {
            'type': 'geojson',
            // 'data': {
            //     'type': circle.type,
            //     'geometry': circle.geometry
            // }
            'data': generateCircles(150)
        })

        map.addLayer({
            'id': 'test',
            'type': 'fill-extrusion',
            'source': 'test',
            'paint': {
                'fill-extrusion-color': 'blue',
                'fill-extrusion-height': 300,
                'fill-extrusion-opacity': 0.5,
                'fill-extrusion-vertical-gradient': false
                // 'fill-extrusion-base': 50

            }
        });

        map.addSource('earthquakes', {
            type: 'geojson',
            // Use a URL for the value for the `data` property.
            data: 'antennes-belfort.geojson'
        });

        map.addLayer({
            'id': 'earthquakes-layer',
            'type': 'circle',
            'source': 'earthquakes',
            'paint': {
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-color': 'blue',
                'circle-opacity': 0.2,
                'circle-stroke-color': 'white'
            }
        });

        map.on('click', 'earthquakes-layer', (e) => {
            // Copy coordinates array.
            const coordinates = e.features[0].geometry.coordinates.slice();
            const description = e.features[0].properties.adm_lb_nom;
            // description += e.features[0].properties.adr_lb_add1;

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(description)
                .addTo(map);
        });
    });

</script>

</html>